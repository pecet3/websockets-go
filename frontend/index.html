<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Chat</title>
</head>
<body class="bg-slate-900 flex flex-col gap-2 justify-center items-center">
<section class="bg-slate-300 p-2 rounded-md m-6">
    <h1>Chat</h1>
    <form id="chatroom-select">
        <label for="chatroom" >Chatroom:</label>
        <input type="text" id="chatroom" name="chatroom"><br>
        <button type="submit" class="p-1 bg-black text-white rounded-lg">Change</button>

    </form>

    <textarea class="message" id="chatmessages" readonly name="chatmessages"
    rows="4" cols="50"></textarea>

    <br>

    <form id="chatroom-message">
        <label for="message">Message:</label>
        <input type="text" id="message" name="message"><br> <br>
        <button type="submit" class="p-1 bg-black text-white rounded-lg">Send</button>
    </form>
</section>

<script>
    let selectedChat = "general";
    let conn;

    class Event {
        constructor(type,payload){
            this.type = type
            this.payload = payload
        }
    }

    function routeEvent(event){
        if (event.type === undefined){
            alert("no type field in the event")
        }

        switch(event.type){
            case "new_message":
                console.log("new message")
                break;
            default:
                alert("unsupporting message type")
                break;     
        }
    }

    function sendEvent(eventName, payload){
        const event = new Event(eventName, payload)
      
        conn.send(JSON.stringify(event))
    }

    


    function changeChatRoom() {
        const newChat = document.getElementById("chatroom");

        if (newChat !== null && newChat.value !== selectedChat) {
            console.log(newChat.value);
        }
        return false;
    }

    function sendMessage() {
        const newMessage = document.getElementById("message");

        if (newMessage !== null) {
            sendEvent("send_message", newMessage.value)
        }
        return false;
    }

    window.onload = function() {
        document.getElementById("chatroom-select").addEventListener("submit", (e) => {
            e.preventDefault();
            changeChatRoom();
        });

        document.getElementById("chatroom-message").addEventListener("submit", (e) => {
            e.preventDefault();
            sendMessage();
        });

        if (window.WebSocket) {
            console.log("Supporting websockets");
            conn = new WebSocket("ws://" + document.location.host + "/ws");

            conn.onmessage = (evt)=>{
                const eventData = JSON.parse(evt.data)

                const event = Object.assign(new Event. eventData)
            }
        } else {
            alert("Your browser doesn't support websockets");
        }
    };
</script>


</body>
</html>